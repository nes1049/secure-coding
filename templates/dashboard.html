{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block content %}
<h2>ëŒ€ì‹œë³´ë“œ</h2>

<h3>ìƒí’ˆ ê²€ìƒ‰</h3>
<form action="{{ url_for('search') }}" method="get" style="margin-bottom: 20px;">
  <input type="text" name="q" placeholder="ìƒí’ˆ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰" required>
  <button type="submit">ê²€ìƒ‰</button>
</form>
<hr>

<h3>ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ</h3>
<ul>
  {% for product in my_products %}
    <li>
      <a href="{{ url_for('view_product', product_id=product.id) }}">{{ product.title }}</a>
      - ê°€ê²©: {{ "{:,}".format(product.price | int) }}ì›
      <a href="{{ url_for('edit_product', product_id=product.id) }}">[ìˆ˜ì •]</a>
      <form action="{{ url_for('delete_product', product_id=product.id) }}" method="post"
            style="display:inline; margin-left: 5px;" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button type="submit" style="
          all: unset;
          color: red;
          cursor: pointer;
        ">[ì‚­ì œ]</button>
      </form>
    </li>
  {% else %}
    <li>ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</li>
  {% endfor %}
</ul>
<p><a href="{{ url_for('new_product') }}">ìƒˆ ìƒí’ˆ ë“±ë¡</a></p>
<hr>

<h3>ì „ì²´ ìƒí’ˆ</h3>
<ul>
  {% for product in all_products %}
  <li style="border-bottom: 1px solid #ccc; margin-bottom: 10px;">
    <a href="{{ url_for('view_product', product_id=product.id) }}">{{ product.title }}</a>
    - ê°€ê²©: {{ "{:,}".format(product.price | int) }}ì›
    / íŒë§¤ì: {{ product.username }}

    {% if session.get('is_admin') == 1 %}
      <form action="{{ url_for('delete_product', product_id=product.id) }}" method="post"
            style="display:inline;" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button type="submit" style="all: unset; color:red; cursor:pointer; margin-left: 4px;">
          [ì‚­ì œ]
        </button>
      </form>
    {% endif %}
  </li>
  {% endfor %}
</ul>


<h3>ì‹¤ì‹œê°„ ì±„íŒ…</h3>
<div id="chat">
  <ul id="messages"></ul>
  <input id="chat_input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
  <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<script type="text/javascript">
  var socket = io();

  function sendMessage() {
    var input = document.getElementById('chat_input');
    var message = input.value;
    if (message) {
      socket.emit('send_message', { 'username': "{{ user.username }}", 'message': message });
      input.value = "";
    }
  }


  function addMessage(username, message, timestamp) {
    const messages = document.getElementById('messages');
    const item = document.createElement('li');

    console.log("ğŸ“¦ ë°›ì€ timestamp:", timestamp);

    let timeStr = '[Invalid Date]';
    if (timestamp) {
      const dateObj = new Date(timestamp);
      if (!isNaN(dateObj.getTime())) {
        timeStr = dateObj.toLocaleString();  // âœ… ë¸Œë¼ìš°ì € ë¡œì»¬ í¬ë§·
      }
    }

    item.textContent = `[${timeStr}] ${username}: ${message}`;
    messages.appendChild(item);
  }


  socket.on('connect', function() {
      console.log("ì±„íŒ… ì„œë²„ì— ì—°ê²°ë¨");

      // ì €ì¥ëœ ë©”ì‹œì§€ ë¡œë”©
      fetch("{{ url_for('load_public_messages') }}")
        .then(response => response.json())
        .then(data => {
          data.messages.forEach(function(msg) {
            addMessage(msg.username, msg.message, msg.timestamp);
          });
        });
  });

  socket.on('message', function(data) {
      addMessage(data.username, data.message, data.timestamp);
  });
</script>
{% endblock %}
